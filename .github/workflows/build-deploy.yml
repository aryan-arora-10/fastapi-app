name: Build and Deploy FastAPI app

on:
  push:
    branches:
      - main

jobs:
    testapp:
      environment: 
        name: testing
      env:
        DATABASE_HOST: ${{secrets.DATABASE_HOST}}
        DATABASE_PORT: ${{secrets.DATABASE_PORT}}
        DATABASE_PASSWORD: ${{secrets.DATABASE_PASSWORD}}
        DATABASE_NAME: ${{secrets.DATABASE_NAME}}
        DATABASE_NAME_TEST: ${{secrets.DATABASE_NAME_TEST}}
        DATABASE_USERNAME: ${{secrets.DATABASE_USERNAME}}
        SECRET_KEY: ${{secrets.SECRET_KEY}}
        ALGORITHM: ${{secrets.ALGORITHM}}
        ACCESS_TOKEN_EXPIRE_MINUTES: ${{secrets.ACCESS_TOKEN_EXPIRE_MINUTES}}
      
      runs-on: ubuntu-latest
      steps:
        - name: pulling the git repo
          uses: actions/checkout@v3
        # - name: installing python
        #   uses: actions/setup-python@v4
        #   with:
        #     python-version: "3.10"
        # - name: upgrade pip 
        #   run: python -m pip install --upgrade pip
        # - name: installing all dependencies
        #   run: pip install -r requirements.txt
        # - name: test with pytest
        #   run: |
        #     pip install pytest
        #     pytest
        #     echo "Pilot Test successful"

          
    deployapp:
      environment:
        name: prodfast
      runs-on: ubuntu-latest
      needs: [testapp]
      steps:
        - name: using apple boy
          uses: appleboy/ssh-action
          with:
            host: ${{secrets.EC2_HOST}}
            username: ${{secrets.EC2_USER}}
            key: ${{secrets.SSH_PRIVATE_KEY}}
        - name: git pull and deploy
        #  StrictHostKeyChecking=no can be used in the SSH command
        # ssh -v  {{secrets.EC2_USER}}@{{secrets.EC2_HOST}}  
          run: |
            cd app/src/ << 'EOF'
            git pull origin main
            docker compose -f docker-compose-prod.yaml down
            docker compose -f docker-compose-prod.yaml up -d
            echo "Deployment successful"
            EOF
            
            